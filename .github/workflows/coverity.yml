name: Coverity Scan

on:
  # Trigger on push to workflow file and relevant source/build files
  push:
    paths:
      - '.github/workflows/coverity.yml'
      - 'src/**'
      - 'include/**'
      - '**/*.c'
      - '**/*.cc'
      - '**/*.cpp'
      - '**/*.cxx'
      - 'CMakeLists.txt'
  # Weekly automatic scan on the default branch only. GitHub cron schedules run in UTC.
  # Currently aligned to run at 06:00 UTC on Sunday, intended to be ~4 hours after the full_analysis workflow (02:00 UTC).
  schedule:
    - cron: '0 6 * * 0'
  # Manual trigger - can select any branch from GitHub Actions UI
  workflow_dispatch:

permissions:
  contents: read

jobs:
  coverity:
    name: Coverity Static Analysis
    runs-on: ubuntu-24.04
    
    env:
      COVERITY_PROJECT: lrleon/Aleph-w
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            g++ \
            libgmp-dev libmpfr-dev libgsl-dev \
            libx11-dev libpthread-stubs0-dev

      - name: Download Coverity Build Tool
        run: |
          echo "Downloading Coverity Build Tool..."
          curl -fsS -o cov-analysis.tar.gz \
            --form token=${{ secrets.COVERITY_SCAN_TOKEN }} \
            --form project=${{ env.COVERITY_PROJECT }} \
            https://scan.coverity.com/download/cxx/linux64
          
          # Validate that the downloaded file is a readable gzip tar archive
          tar tzf cov-analysis.tar.gz > /dev/null
          
          mkdir -p cov-analysis
          tar --extract --gzip \
              --file=cov-analysis.tar.gz \
              --directory=cov-analysis \
              --strip-components=1 \
              --no-same-owner \
              --no-same-permissions
          echo "${{ github.workspace }}/cov-analysis/bin" >> $GITHUB_PATH

      - name: Configure project
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF

      - name: Build with Coverity
        run: |
          echo "Running Coverity build analysis..."
          cov-build --dir cov-int cmake --build build --parallel
          
          # Show capture summary (do not fail if log file is missing)
          tail -20 cov-int/build-log.txt || true

      - name: Package results
        run: |
          echo "Packaging Coverity results..."
          tar czf aleph-w-coverity.tgz cov-int
          ls -lh aleph-w-coverity.tgz

      - name: Submit to Coverity Scan
        run: |
          echo "Submitting to Coverity Scan..."
          
          # Get version info
          VERSION="${{ github.ref_name }}@${{ github.sha }}"
          DESCRIPTION="GitHub Actions build from branch ${{ github.ref_name }} (commit ${{ github.sha }})"
          
          curl -fsS \
            --form token=${{ secrets.COVERITY_SCAN_TOKEN }} \
            --form email=${{ secrets.COVERITY_SCAN_EMAIL }} \
            --form file=@aleph-w-coverity.tgz \
            --form version="$VERSION" \
            --form description="$DESCRIPTION" \
            "https://scan.coverity.com/builds?project=${{ env.COVERITY_PROJECT }}"
          
          echo ""
          echo "âœ… Build submitted successfully!"
          echo "ðŸ“Š View results at: https://scan.coverity.com/projects?project=${{ env.COVERITY_PROJECT }}"

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverity-build-log
          path: |
            cov-int/build-log.txt
            cov-int/emit/*/emit-db.write-log
          retention-days: 7

